<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Chatterbox – Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="h-screen flex bg-yellow-50">

<!-- USERS LIST -->
<div class="w-1/3 max-w-xs bg-white border-r p-4">
  <h2 class="text-xl font-bold mb-4 text-yellow-500">Online Users</h2>
  <ul id="usersList" class="space-y-2"></ul>
</div>

<!-- CHAT AREA -->
<div class="flex-1 flex flex-col">
  <div class="bg-white p-4 border-b font-bold text-gray-700">
    Chat with <span id="activeUser" class="text-yellow-500">—</span>
  </div>

  <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-2"></div>

  <form id="chatForm" class="flex p-4 bg-white border-t">
    <input
      id="messageInput"
      class="flex-1 border rounded-l px-4 py-2 focus:outline-none"
      placeholder="Type a message..."
    />
    <button
      class="bg-yellow-400 px-6 rounded-r font-bold"
      type="submit"
    >
      Send
    </button>
  </form>
</div>

<script>
const username = localStorage.getItem("chatterbox_user");
if (!username) {
  alert("Please login first");
  window.location.href = "login.html";
}

let activeChatUser = null;
const socket = new WebSocket("ws://localhost:5000");

// DOM refs
const usersList = document.getElementById("usersList");
const messagesDiv = document.getElementById("messages");
const activeUserSpan = document.getElementById("activeUser");
const chatForm = document.getElementById("chatForm");
const messageInput = document.getElementById("messageInput");

// When connected
socket.onopen = () => {
  socket.send(JSON.stringify({
    type: "join",
    username
  }));
};

// Incoming messages
socket.onmessage = (event) => {
  const data = JSON.parse(event.data);

  // Update online users
  if (data.type === "online-users") {
    usersList.innerHTML = "";
    data.users
      .filter(u => u !== username)
      .forEach(user => {
        const li = document.createElement("li");
        li.textContent = user;
        li.className = "cursor-pointer p-2 rounded hover:bg-yellow-100";
        li.onclick = () => selectUser(user);
        usersList.appendChild(li);
      });
  }

  // Incoming chat message
  if (data.type === "message") {
    addMessage(`${data.from}: ${data.message}`, "bg-gray-200");
  }
};

// Select user to chat with
function selectUser(user) {
  activeChatUser = user;
  activeUserSpan.textContent = user;
  messagesDiv.innerHTML = "";
}

// Send message
chatForm.addEventListener("submit", (e) => {
  e.preventDefault();
  if (!activeChatUser) return alert("Select a user first");

  const message = messageInput.value.trim();
  if (!message) return;

  socket.send(JSON.stringify({
    type: "message",
    to: activeChatUser,
    message
  }));

  addMessage(`You: ${message}`, "bg-yellow-200");
  messageInput.value = "";
});

// Add message to UI
function addMessage(text, style) {
  const div = document.createElement("div");
  div.className = `p-2 rounded ${style} max-w-xs`;
  div.textContent = text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
</script>

</body>
</html>
